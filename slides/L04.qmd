---
title: "Assessing Assumptions on *t*-Tests, Mann-Whitney *U*, Wilcoxon Rank Sum"
subtitle: "STA4173: Biostatistics"
execute:
  echo: true
format: 
  revealjs:
    theme: uwf
    self-contained: true
    slide-number: false
    footer: "[STA4173 - Biostatistics](https://samanthaseals.github.io/STA4173)"
    width: 1600
    height: 900
    df-print: paged
    html-math-method: katex
editor: source
---

## Introduction: Assumptions

- We have now learned one- and two-sample *t*-tests.

- Recall, when we have two samples, they can be independent samples or dependent samples.

    - Independent samples: two-sample *t*-test
    
    - Dependent samples: paired *t*-test (one-sample *t*-test on difference)
    
- Today we will discuss how to assess the assumptions on *t*-tests.

## Normality Assumption: Set Up

- All *t*-tests assume approximate normality of the data.

    - In the case of one-sample *t*-tests, the measure of interest must somewhat follow a normal distribution.

    - In the case of two-sample *t*-tests, the measure of interest *in each group* must somewhat follow a normal distribution.
    
- Note that a paired *t*-test is technically a one-sample *t*-test, so we will examine normality of the difference. 

## Normality Assumption: Set Up

- There are formal tests for normality ([see article here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3693611/)), however, we will not use them.

    - Tests for normality are not well-endorsed by statisticians.
    
- Instead, we will assess normality using a quantile-quantile (q-q) plot.

    - This is a scatterplot that will form a 45&deg; line if the assumed distribution is correct.
    
    - [Here is more information about q-q plots](https://data.library.virginia.edu/understanding-q-q-plots/).

- We will create q-q plots for:

    - The measurements in the case of the one-sample *t*-test.

    - The measurements from each group in the case of the two-sample *t*-test.
    
    - The difference between the groups in the case of the paired *t*-test.
    
## Normality Assumption: R Syntax

- We will assess the normality assumption graphically using a q-q plot
    
- A package was written by a former student, [`classpackage`](https://github.com/ieb2/class_package).

    - If you **are** working on the server, the package is already installed.

    - If you are **not** working on the server, you need to install the package:
    
```{r}
#| eval: false
# install.packages("devtools") - use this if R tells you it can't find install_github()
library(devtools)
install_github("ieb2/class_package", force = TRUE)
```

## Normality Assumption: Independent Data - R Syntax

- Once installed, we call the package,

```{r}
library(classpackage)
```

- While there are several functions in this package, we are interested in the `independent_qq_plot()` function.

```{r}
#| eval: false
dataset_name %>% independent_qq_plot(variable = "continuous variable",
                                     grouping_variable = "grouping variable")
```

- This will provide the the q-q plot for the two-sample *t*-test (i.e., for independent data).

## Normality Assumption: Independent Data - Example

- Recall the space/earth rat example for the two-sample *t*-test.

::: {.panel-tabset}

## Code

```{r}
#| eval: false
library(tidyverse)
rbc <- c(8.59, 8.64, 7.43, 7.21, 6.39, 6.87, 7.89, 9.79, 6.85, 7.54, 7.00, 8.80, 9.30, 8.03, # space
         8.65, 6.99, 8.40, 9.66, 7.14, 7.62, 7.44, 8.55, 8.70, 9.14, 7.33, 8.58, 9.88, 9.94) # earth
rat <- c(rep("Space", 14), rep("Earth", 14)) # enter identifier 
earth_space_rats <- tibble(rat, rbc) # create dataset
earth_space_rats %>% independent_qq_plot(variable = "rbc",
                                         grouping_variable = "rat")
```

## Graph

<center>
```{r}
#| echo: false
library(tidyverse)
rbc <- c(8.59, 8.64, 7.43, 7.21, 6.39, 6.87, 7.89, 9.79, 6.85, 7.54, 7.00, 8.80, 9.30, 8.03, # space
         8.65, 6.99, 8.40, 9.66, 7.14, 7.62, 7.44, 8.55, 8.70, 9.14, 7.33, 8.58, 9.88, 9.94) # earth
rat <- c(rep("Space", 14), rep("Earth", 14)) # enter identifier 
earth_space_rats <- tibble(rat, rbc) # create dataset
earth_space_rats %>% independent_qq_plot(variable = "rbc",
                                         grouping_variable = "rat")
```
</center>

:::

## Normality Assumption: Dependent Data - R Syntax

- While there are several functions in the `classpackage` package, we are interested in the `dependent_qq_plot()` function.

- For long data:
```{r}
#| eval: false
long_data %>% dependent_qq_plot(variable = "continuous_variable", # continuous variable name
                                grouping_variable = "grouping_variable", # grouping variable name
                                first_group = "first", # what identifies the first group in grouping_variable
                                second_group = "second") # what identifies the second group in grouping_variable
```

- For wide data:

```{r}
#| eval: false
wide_data %>% dependent_qq_plot(variable = "Display Name of Continuous Variable", # edit this accordingly; it will label your graph
                                grouping_variable = " ", # do not edit this line
                                first_group = "first_measurement", # first column for comparison
                                second_group = "second_measurement") # second column for comparison
```

- This will provide the the q-q plot for the paired *t*-test (i.e., for dependent data).

## Normality Assumption: Repair Estimates

- Recall the repair estimate example for the dependent *t*-test.

::: {.panel-tabset}

## Long Data

- This is long data:

```{r}
estimate <- c(17.6, 20.2, 19.5, 11.3, 13.0, 16.3, 15.3, 16.2, 12.2, 14.8, 21.3, 22.1, 16.9, 17.6, 18.4,
         17.3, 19.1, 18.4, 11.5, 12.7, 15.8, 14.9, 15.3, 12.0, 14.2, 21.0, 21.0, 16.1, 16.7, 17.5)
garage <- c(rep("G1", 15), rep("G2", 15)) 
long_data <- tibble(garage, estimate)
```

## Q-Q Plot Code

```{r}
#| eval: false
long_data %>% dependent_qq_plot(variable = "estimate",
                                grouping_variable = "garage",
                                first_group = "G1",
                                second_group = "G2")
```


## Q-Q Plot Results

<center>
```{r}
#| echo: false
long_data %>% dependent_qq_plot(variable = "estimate",
                                grouping_variable = "garage",
                                first_group = "G1",
                                second_group = "G2")
```
</center>

:::

## Normality Assumption: Repair Estimates

- Recall the repair estimate example for the dependent *t*-test.

::: {.panel-tabset}

## Wide Data

- This is wide data:
```{r}
g1 <- c(17.6, 20.2, 19.5, 11.3, 13.0, 16.3, 15.3, 16.2, 12.2, 14.8, 21.3, 22.1, 16.9, 17.6, 18.4)
g2 <- c(17.3, 19.1, 18.4, 11.5, 12.7, 15.8, 14.9, 15.3, 12.0, 14.2, 21.0, 21.0, 16.1, 16.7, 17.5)
wide_data <- tibble(g1, g2) # create dataset with both garages
```

## Q-Q Plot Code

```{r}
#| eval: false
wide_data %>% dependent_qq_plot(variable = "Repair Estimate",
                                grouping_variable = " ",
                                first_group = "g1",
                                second_group = "g2")
```

## Q-Q Plot Results

<center>
```{r}
#| echo: false
wide_data %>% dependent_qq_plot(variable = "Repair Estimate",
                                grouping_variable = " ",
                                first_group = "g1",
                                second_group = "g2")
```
</center>

:::

## Normality Assumption: Wrap Up

- **Important note!!** 

    - *I do not expect you to agree with my assessment of q-q plots!* 
    - What I do expect is that you know what to do after making your assessment.

## Introduction: Wilcoxon Rank Sum / Mann-Whitney *U*

- We just discussed assumptions on *t*-tests

    - Dependent / paired *t*-test: normality
    
    - Independent two-sample *t*-test: normality and variance
  
- If we break the normality assumption, we must look to nonparametric methods.

## Introduction: Wilcoxon Rank Sum / Mann-Whitney *U*

- The *t*-tests we have already learned are considered *parametric* methods.

    - There is a distributional assumption on the test.
    
- *Nonparametric* methods do not have distributional assumptions.

    - We typically transform the data to their ranks and then perform calculations.

- Why don't we always use nonparametric methods?

    - They are often less efficient: a larger sample size is required to achieve the same probability of a Type I error.
    
    - They discard useful information :(
    
## Ranking Data

- In the nonparametric tests we will be learning, the data will be ranked.

- Let us first consider a simple example, $$x: \ 1, 7, 10, 2, 6, 8$$

- Our first step is to reorder the data:$$x: \ 1, 2, 6, 7, 8, 10$$

- Then, we replace with the ranks:$$R: \ 1, 2, 3, 4, 5, 6$$

## Ranking Data

- What if all data values are not unique?

    - We will assign the average ranks.

- For example, $$x: \ 9, 8, 8, 0, 3, 4, 4, 8$$

- Let's reorder:$$x: \ 0, 3, 4, 4, 8, 8, 8, 9$$

- Rank ignoring ties:$$R: \ 1, 2, 3, 4, 5, 6, 7, 8$$

- Now, the final rank:$$R: \ 1, 2, 3.5, 3.5, 6, 6, 6, 8$$

## Wilcoxon Rank Sum / Mann-Whitney *U*

**Wilcoxon Rank Sum / Mann-Whitney *U***

<center><img src="images/L06a.png"></center>

- where *S* is the sum of the ranks from sample 1

## Wilcoxon Rank Sum / Mann-Whitney *U*

-   We will use the [`wilcox.test()`](https://www.rdocumentation.org/packages/stats/versions/3.6.1/topics/wilcox.test) function to perform the test,

```{r, echo = TRUE, eval = FALSE}
wilcox.test(continuous_variable ~ grouping_variable,
            data = dataset_name,
            alternative = "[greater, less, or two]",
            mu = numeric_hypothesized_value,
            exact = FALSE)
```

- Like before, R will use the group that is "first" in the grouping variable.

    - "First" is in terms of numeric or alphabetical.

## Wilcoxon Rank Sum / Mann-Whitney *U*

- When exposed to an infection, a person typically develops antibodies. The extent to which the antibodies respond can be measured by looking at a person’s titer, which is a measure of the number of antibodies present. The higher the titer is, the more antibodies that are present. 

- The following data represent the titers of 11 ill people and 11 healthy people exposed to the tularemia virus in Vermont. 

- Is the level of titer in the ill group greater than the level of titer in the healthy group? Use the $\alpha = 0.1$ level of significance.

```{r}
ill <- c(640, 160, 1280, 320, 80, 640, 640, 160, 1280, 640, 160)
healthy <- c(10, 320, 160, 160, 320, 320, 10, 320, 320, 80, 640)
```

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Is this independent or dependent data?

- From the problem statement: *The following data represent the titers of 11 ill people and 11 healthy people exposed to the tularemia virus in Vermont.*

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Is this independent or dependent data?

- From the problem statement: *The following data represent the titers of 11 ill people and 11 healthy people exposed to the tularemia virus in Vermont.*

    - <font color="#db0b9d">There were 22 people in the study - those that are ill are not in the healthy group.</font>

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Let's first look at the q-q plot,

::: {.panel-tabset}

## Data

```{r}
outcome <- c(640, 160, 1280, 320, 80, 640, 640, 160, 1280, 640, 160,
             10, 320, 160, 160, 320, 320, 10, 320, 320, 80, 640)
group <- c(rep("ill",11), rep("healthy",11))
long_data <- tibble(outcome, group)
```

## Q-Q Plot Code

```{r}
#| eval: false
long_data %>% independent_qq_plot(variable = "outcome",
                                  grouping_variable = "group")
```

## Q-Q Plot Results

<center>
```{r}
#| echo: false
long_data %>% independent_qq_plot(variable = "outcome",
                                  grouping_variable = "group")
```
</center>

:::

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Is the level of titer in the ill group greater than the level of titer in the healthy group?

```{r}
wilcox.test(outcome ~ group, 
            data = long_data,
            exact = FALSE, 
            alternative="less")
```

## Wilcoxon Rank Sum / Mann-Whitney *U*

- **Hypotheses**

    - $H_0: \ M_{\text{ill}} \le M_{\text{healthy}}$ 
    - $H_1: \ M_{\text{ill}} > M_{\text{healthy}}$
    
- **Test Statistic and *p*-Value**

    - $W_0 = 35$
    - $p = 0.047$
    
- **Rejection Region**

    - Reject $H_0$ if $p < \alpha$; $\alpha = 0.10$.
    
- **Conclusion/Interpretation**

    - Reject $H_0$.
    
    - There is sufficient evidence to suggest that the level of titer in the ill group is greater than the level of titer in the healthy group.

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Recall the tapeworm in sheep example from the two-sample *t*-test lecture.

    - A random sample of 24 worm-infested lambs of approximately the same age and health was randomly divided into two groups. 
    
    - Twelve of the lambs were injected with medication and the remaining 12 were left untreated. 

::: {.panel-tabset}

## Data

```{r}
worms <- c(18, 43, 28, 50, 16, 32, 13, 35, 38, 33,  6,  7,
           40, 54, 26, 63, 21, 37, 39, 23, 48, 58, 28, 39)
trt <- c(rep("Treated", 12), rep("Not", 12))
sheep <- tibble(worms, trt)
```

## Q-Q Plot Code

```{r}
#| eval: false
sheep %>% independent_qq_plot(variable = "worms",
                              grouping_variable = "trt")
```

## Q-Q Plot Results

<center>
```{r}
#| echo: false
sheep %>% independent_qq_plot(variable = "worms",
                              grouping_variable = "trt")
```
</center>

:::

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Since we are applying a nonparametric test, we will describe the data using median and IQR.

```{r}
sheep %>% 
  group_by(trt) %>%
  summarize(median(worms), IQR(worms))
```

- There is a median of 30 worms in the treated lambs (IQR = 20.5) and a median of 39 worms in the untreated lambs (IQR = 22.0).

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Is there significant evidence that the untreated lambs have a mean tapeworm count that is more than five units greater than the mean count for the treated lambs? Use $\alpha = 0.10$.

```{r}
wilcox.test(worms ~ trt, 
            data = sheep,
            exact = FALSE, 
            alternative="greater",
            mu = 5)
```

## Wilcoxon Rank Sum / Mann-Whitney *U*

- **Hypotheses**

    - $H_0: \ M_{\text{untreated}} - M_{\text{treated}} \le 5$ 
    - $H_1: \ M_{\text{untreated}} - M_{\text{treated}} > 5$
    
- **Test Statistic and *p*-Value**

    - $W_0 = 94.5$
    - $p = 0.102$
    
- **Rejection Region**

    - Reject $H_0$ if $p < \alpha$; $\alpha = 0.10$.
    
- **Conclusion/Interpretation**

    - Fail to reject $H_0$.
    
    - There is not sufficient evidence to suggest that untreated lambs have a mean tapeworm count that is more than five units greater than the mean count for the treated lambs.

## Introduction: Wilcoxon Signed Rank

- Today we have discussed that we turn to nonparametric tests when we do not meet distributional assumptions for *t*-tests.

- If we do not meet the normality assumption for the paired *t*-test,

- Now we will learn the Wilcoxon signed rank, the nonparametric alternative to the dependent *t*-test.

- Like in the dependent *t*-test, we will analyze the *difference* between two values.

- Like in the Wilcoxon rank sum, we will be analyzing ranks.

## Wilcoxon Signed Rank

- Before ranking, we will find the difference between the paired observations and eliminate any 0 differences.

    - Note 1: elimniating 0 differences is the big difference between the other tests! 
    
    - Note 2: because we are eliminating 0 differences, this means that our sample size will update to the number of pairs with a non-0 difference.
    
- When ranking, we the differences are ranked based on the absolute value of the difference.

- We also keep the sign of the difference.

    - We will have positive ranks and negative ranks.

| *X* | *Y* | *D* | \|*D*\| | Rank |
|-----|-----|-----|---------|------|
| 5   | 8   | -3  | 3       | $-$ 1.5 |
| 8   | 5   | 3   | 3       | $+$ 1.5  |
| 4   | 4   | 0   | 0       | ---------   |

## Wilcoxon Signed Rank

<center><img src="images/L07a.png"></center>

- where

    - $T_+$ is the sum of the positive ranks,
    - $T_-$ is the sum of the negative ranks

## Wilcoxon Signed Rank

-   We will again use the [`wilcox.test()`](https://www.rdocumentation.org/packages/stats/versions/3.6.1/topics/wilcox.test) function to perform the test,

```{r}
#| eval: false
wilcox.test(var1, var2,
       data = dataset_name,
       alternative = "[greater, less, or two]",
       mu = numeric_hypothesized_value,
       paired = TRUE,
       exact = FALSE)
```

## Wilcoxon Signed Rank

- A stock analyst believes the median number of shares traded in Walgreens Boots Alliance (WBA) stock is greater than that in McDonald’s (MCD). Test the analyst’s belief at the $\alpha=0.05$ level of significance.

::: {.panel-tabset}

## Data

```{r}
WBA <- c(8.9, 6.3, 6.2, 7.2, 2.8, 3.3, 23.6, 6.0, 15.6, 5.2, 6.3, 10.1, 4.0, 8.4)
MCD <- c(8.5, 7.6, 8.3, 10.4, 2.5, 2.6, 3.5, 4.7, 9.0, 6.0, 5.6, 5.0, 4.4, 5.6)
stocks <- tibble(WBA, MCD) 
```

## Q-Q Plot Code

```{r}
#| eval: false
stocks %>% dependent_qq_plot(variable = "Median Number of Trades",
                                grouping_variable = " ",
                                first_group = "WBA",
                                second_group = "MCD")
```

## Q-Q Plot Results

<center>
```{r}
#| echo: false
stocks %>% dependent_qq_plot(variable = "Median Number of Trades",
                                grouping_variable = " ",
                                first_group = "WBA",
                                second_group = "MCD")
```
</center>

:::

## Wilcoxon Signed Rank

- Let's also look at summary statistics,

```{r}
stocks %>% summarize(median(WBA), median(MCD), median(WBA-MCD))
stocks %>% summarize(IQR(WBA), IQR(MCD), IQR(WBA-MCD))
```

- The median for the WBA stock is 6.3 (IQR 3.375) while the median for MCD stock is 5.6 (IQR 3.65).

- The median for the difference between WBA and MCD is 0.55 (IQR 3.125).

## Wilcoxon Signed Rank

- Let's now perform the hypothesis test,

    - From the problem statement: *A stock analyst believes the median number of shares traded in Walgreens Boots Alliance (WBA) stock is greater than that in McDonald’s (MCD).*

```{r}
wilcox.test(WBA, MCD,
       data = stocks,
       alternative = "greater",
       paired = TRUE, 
       exact = FALSE)
```

## Wilcoxon Signed Rank

- **Hypotheses**

    - $H_0: \ M_{\text{WBA}} \le M_{\text{MCD}}$ OR $M_d \le 0$, where $d = \text{WBA} - \text{MCD}$
    - $H_1: \ M_{\text{WBA}} > M_{\text{MCD}}$ OR $M_d > 0$
    
- **Test Statistic and *p*-Value**

    - $V_0 = 69$
    - $p = 0.158$
    
- **Rejection Region**

    - Reject $H_0$ if $p < \alpha$; $\alpha = 0.05$.
    
- **Conclusion/Interpretation**

    - Fail to reject $H_0$.
    
    - There is not sufficient evidence to suggest that the median stock shares traded is greater for WBA than for MCD.
    
## Wilcoxon Signed Rank

- Recall the insurance data we examined with the paired *t*-test.

    - *Insurance adjusters are concerned about the high estimates they are receiving for auto repairs from garage I compared to garage II.*

::: {.panel-tabset}

## Data 

```{r}
g1 <- c(17.6, 20.2, 19.5, 11.3, 13.0, 16.3, 15.3, 16.2, 12.2, 14.8, 21.3, 22.1, 16.9, 17.6, 18.4)
g2 <- c(17.3, 19.1, 18.4, 11.5, 12.7, 15.8, 14.9, 15.3, 12.0, 14.2, 21.0, 21.0, 16.1, 16.7, 17.5)
garage <- tibble(g1, g2) 
```

## Q-Q Plot Code

```{r}
#| eval: false
garage %>% dependent_qq_plot(variable = "Repair Estimate",
                                grouping_variable = " ",
                                first_group = "g1",
                                second_group = "g2")
```

## Q-Q Plot Results

<center>
```{r}
#| echo: false
garage %>% dependent_qq_plot(variable = "Repair Estimate",
                                grouping_variable = " ",
                                first_group = "g1",
                                second_group = "g2")
```
</center>

:::

## Wilcoxon Signed Rank

- Looking at summaries,

```{r}
garage %>% summarize(median(g1), median(g2), median(g1-g2))
garage %>% summarize(IQR(g1), IQR(g2), IQR(g1-g2))
```

- The median estimate for garage 1 is \$169 (IQR \$39), while the median estimate for garage 2 is $161 (IQR \$34). 

- The median difference between garage 1 and garage 2 is \$6 (IQR $\6).

## Wilcoxon Signed Rank

```{r, eval = FALSE}
wilcox.test(g1, g2,
       data = garage,
       alternative = "greater",
       paired = TRUE, 
       exact = FALSE)
```

## Wilcoxon Signed Rank

- **Hypotheses**

    - $H_0: \ M_{\text{I}} \le M_{\text{II}}$ OR $M_d \le 0$, where $d = \text{I} - \text{II}$
    - $H_1: \ M_{\text{I}} > M_{\text{II}}$ OR $M_d > 0$
    
- **Test Statistic and *p*-Value**

    - $T = 118.5$
    - $p < 0.001$
    
- **Rejection Region**

    - Reject $H_0$ if $p < \alpha$; $\alpha = 0.05$.
    
- **Conclusion/Interpretation**

    - Reject $H_0$.
    
    - There is  sufficient evidence to suggest that the median repair estimate from garage I is higher than that of garage II.


































