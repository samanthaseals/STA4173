---
title: "Kruskal-Wallis: Nonparametric One-Way ANOVA"
subtitle: "STA4173: Biostatistics"
execute:
  echo: true
format: 
  revealjs:
    theme: uwf
    self-contained: true
    slide-number: false
    footer: "[STA4173 - Biostatistics](https://samanthaseals.github.io/STA4173)"
    width: 1600
    height: 900
    df-print: paged
    html-math-method: katex
editor: source
---

## Introduction

- Last lecture, we discussed the ANOVA assumptions.

$$\varepsilon_{ij} \overset{\text{iid}}{\sim} N(0, \sigma^2)$$

- We also discussed how to assess the assumptions:

    - Graphically using the `almost_sas()` function.
    
    - Confirming the variance assumption using the BFL.

- If we break an assumption, we will turn to the nonparametric alternative, the Kruskal-Wallis.

## Kruskal-Wallis Test

- If we break ANOVA assumptions, we should implement the nonparametric version, the Kruskal-Wallis.

- The Kruskal-Wallis test determines if $k$ independent samples come from populations with the same distribution. 

- Our new hypotheses are

    - $H_0:$ the distributions of the populations are identical
    - $H_1:$ the distributions of the populations are not identical
    
- Alternatively,

    - $H_0: M_1 = ... = M_k$
    - $H_1:$ at least one $M_i$ is different

## Kruskal-Wallis Test

- The test statistic is as follows: $$ H = \frac{12}{n(n+1)} \sum_{i=1}^k \frac{R_i^2}{n_i} - 3(n+1), $$ where
    
    - $R_i$ is the sum of the ranks for group $i$,
    - $n_i$ is the sample size for group $i$,
    - $n = \sum_{i=1}^k n_i$ = total sample size, and
    - $k$ is the number of groups.

- $H$ follows a $\chi^2$ distribution with $k-1$ degrees of freedom.

## Kruskal-Wallis Test

**Hypotheses**

  - $H_0: \ M_1 =  ... = M_k$
  - $H_1:$ at least one $M_i$ is different
  
**Test Statistic**

  - $H_0 = \frac{12}{n(n+1)} \sum_{i=1}^k \frac{R_i^2}{n_i} - 3(n+1)$ 
  
***p*-Value**

  - $p = P[H_0 \ge \chi^2_{k-1}]$

**Rejection Region**

  - Reject $H_0$ if $p < \alpha$
  
## Kruskal-Wallis Test

- We will use the [`kruskal.test()`](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/kruskal.test) function to perform the Kruskal-Wallis test.

```{r, echo = TRUE, eval = FALSE}
kruskal.test([outcome variable] ~ [grouping variable], 
             data = [dataset])
```

## Example: HDL
    
-A family doctor wants to determine if the distributions of HDL cholesterol in males for the age groups 20 to 29 years, 40 to 49 years, and 60 to 69 years old are different. 

- He obtains a simple random sample of 12 individuals from each age group and determines their HDL cholesterol. 

- Do the data indicate the distributions vary depending on age? Use the $\alpha = 0.05$ level of significance.

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
HDL <- c(54, 43, 38, 30, 61, 53, 35, 34, 39, 46, 50, 35,
         61, 41, 44, 47, 33, 29, 59, 35, 34, 74, 50, 65,
         44, 65, 62, 53, 51, 49, 49, 42, 35, 44, 37, 38)
age <- c(rep("20 to 29", 12), rep("40 to 49", 12), rep("60 to 69", 12))
data <- tibble(age, HDL)
```

## Example: HDL

- Let's first assess the ANOVA assumptions:

<center>
```{r, echo = FALSE}
almost_sas <- function(aov.results){
  aov_residuals <- residuals(aov.results)
  par(mfrow=c(2,2))
  plot(aov.results, which=1)
  hist(aov_residuals)
  plot(aov.results, which=2)
}
almost_sas(lm(HDL ~ age, data = data))
```
</center>

## Example: HDL

```{r}
kruskal.test(HDL ~ age, data = data)
```

## Example: HDL 

**Hypotheses**

  - $H_0: \ M_1 = M_2 = M_3$
  - $H_1:$ at least one $M_i$ is different
  
**Test Statistic and *p*-Value**

  - $H = 1.012$ 
  - $p = 0.602$

**Rejection Region**

  - Reject $H_0$ if $p < \alpha$
  
**Conclusion/Interpretation**

  - Fail to reject $H_0$.
  - There is not sufficient evidence to suggest that there is a difference between the three groups.

\begin{frame}{Kruskal-Wallis Test}

\begin{center}
    \includegraphics[scale=0.3]{images/L81fig2.png}
\end{center}
    
\end{frame}

## Kruskal-Wallis: Posthoc Testing

- We can also perform posthoc testing in the Kruskal-Wallis setting.\vskip1em

- The set up is just like Tukey's -- we can perform all pairwise comparisons and control for the Type I error rate. \vskip1em

- Instead of using $|\bar{y}_i - \bar{y}_j|$, we will use $|\bar{R}_i - \bar{R}_j|$, where $\bar{R}_i$ is the average rank of group $i$.

- The comparison we are making:

    - We declare $M_i \ne M_j$ if $|\bar{R}_i - \bar{R}_j| \ge KW$, where
    $$ KW = \frac{q_{\alpha}(k, \infty)}{\sqrt{2}} \sqrt{\frac{n(n+1)}{12} \left( \frac{1}{n_i} + \frac{1}{n_j} \right)} $$ and $q_{\alpha}(k, \infty)$ is the critical value from the Studentized range distribution.

## Kruskal-Wallis: Posthoc Testing

- We will use the [`kruskalmc()`](https://www.rdocumentation.org/packages/pgirmess/versions/2.0.0/topics/kruskalmc) function from the [`pgirmess` package](https://www.rdocumentation.org/packages/pgirmess/versions/2.0.0) to perform the Kruskal-Wallis post-hoc test.

```{r, echo = TRUE, eval = FALSE}
kruskalmc([outcome variable] ~ [grouping variable], 
          data = [dataset])
```

## Example: HDL

- Revisiting our example,

    - Note that if we were doing this "for real" we would not do the posthoc test since we did not see a difference between the three groups.
    
    - We are doing it here for demonstration purposes.

```{r}
library(pgirmess) 
kruskalmc(HDL ~ age, data = data)
```

- Thus, none of the groups are different from one another.

## Example: Penguins

- Recall the [Palmer Penguin](https://allisonhorst.github.io/palmerpenguins/) data in R.

- Let's check the differences in bill lengths using the Kruskal-Wallis.

```{r, echo = TRUE}
penguins <- palmerpenguins::penguins
kruskal.test(bill_length_mm ~ species, data = penguins)
```

## Example: Penguins

**Hypotheses**

  - $H_0: \ M_1 = M_2 = M_3$
  - $H_1:$ at least one $M_i$ is different
  
**Test Statistic and *p*-Value**

  - $H =244.14$ 
  - $p < 0.001$

**Rejection Region**

  - Reject $H_0$ if $p < \alpha$
  
**Conclusion/Interpretation**

  - Reject $H_0$.
  - There is sufficient evidence to suggest that there is a difference in bill length between the three species.
  
## Example: Penguins

<center>
```{r, echo = FALSE}
penguins %>% ggplot(aes(y = bill_length_mm, x = species, fill = species)) +
  geom_boxplot() +
  theme_bw()
```
</center>
  
## Example: Penguins

```{r}
kruskalmc(bill_length_mm ~ species, data = penguins)
```

- Adelies are different from both chinstraps and gentoos.

- Chinstraps and gentoos are not different.







