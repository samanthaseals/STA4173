---
title: "ANOVA Assumptions"
subtitle: "STA4173: Biostatistics"
execute:
  echo: true
format: 
  revealjs:
    theme: uwf
    self-contained: true
    slide-number: false
    footer: "[STA4173 - Biostatistics](https://samanthaseals.github.io/STA4173)"
    width: 1600
    height: 900
    df-print: paged
    html-math-method: katex
editor: source
---

## Introduction

- We previously discussed testing three or more means using ANOVA.

- We also discussed that ANOVA is an extension of the two-sample *t*-test.

- Recall that the *t*-test has two assumptions:

    - Equal variance between groups.
    
    - Normal distribution.
    
- We will extend our knowledge of checking assumptions today.    

## ANOVA Assumptions: Definition

- We can represent ANOVA with the following model:
$$ y_{ij} = \mu + \tau_i + \varepsilon_{ij} $$

- where:

    - $y_{ij}$ is the $j^{\text{th}}$ observation in the $i^{\text{th}}$ group,
    - $\mu$ is the overall (grand) mean,
    - $\tau_i$ is the treatment effect for group $i$, and
    - $\varepsilon_{ij}$ is the error term for the $j^{\text{th}}$ observation in the $i^{\text{th}}$ group.
    
## ANOVA Assumptions: Definition

- We assume that the error term follows a normal distribution with mean 0 and a constant variance, $\sigma^2$. i.e.,
$$\varepsilon_{ij} \overset{\text{iid}}{\sim} N(0, \sigma^2)$$

- Very important note: **the assumption is on the error term** and NOT on the outcome!

- We will use the residual (the difference between the observed value and the predicted value) to assess assumptions:
$$ e_{ij} = y_{ij} - \hat{y}_{ij} $$

## ANOVA Assumptions: Graphical Assessment
    
- **Normality**: histogram of residuals

    - Should be mound-shaped and symmetric
    - Should be centered at $\mu=0$
    - Note: it may look "wonky" when sample sizes are small
    
- **Normality**: quantile-quantile plot

    - Should have points close to the 45$^\circ$ line
    - We will focus on the "center" portion of the plot
    
- **Variance**: scatterplot of the residuals against the predicted values

    - Should be "equal spread" between the groups
    - No "pattern"

## ANOVA Assumptions: Assessing Graphically

- We will construct a matrix of graphs to assess assumptions.

    - If we decide that the variance is questionable, we can (and will) formally test it.
    
    - I always base my final decision about normality on the q-q plot.
        
- R syntax to put together the matrix of graphs (credit: former graduate student, Reid Ginoza)

```{r, eval = FALSE}
# define function to construct graph for assumptions
almost_sas <- function(aov.results){
  aov_residuals <- residuals(aov.results)
  par(mfrow=c(2,2))
  plot(aov.results, which=1)
  hist(aov_residuals)
  plot(aov.results, which=2)
}

# use the function to create the graph
almost_sas([model results])
```

## ANOVA Assumptions: Assessing Graphically

- Recall the dental data,

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
strength <- c(15.4, 12.9, 17.2, 16.6, 19.3,
              17.2, 14.3, 17.6, 21.6, 17.5,
               5.5,  7.7, 12.2, 11.4, 16.4,
              11.0, 12.4, 13.5,  8.9,  8.1)
system <- c(rep("Cojet",5), rep("Silistor",5), rep("Cimara",5), rep("Ceramic",5))
data <- tibble(system, strength)
m <- aov(strength ~ system, data = data)
summary(m)
```

## ANOVA Assumptions: Assessing Graphically

- Let's assess the assumptions graphically,

```{r, eval = FALSE}
# define function to construct graph for assumptions
almost_sas <- function(aov.results){
  aov_residuals <- residuals(aov.results)
  par(mfrow=c(2,2))
  plot(aov.results, which=1)
  hist(aov_residuals)
  plot(aov.results, which=2)
}

# use the function to create the graph
almost_sas(m)
```

## ANOVA Assumptions: Assessing Graphically

- Let's assess the assumptions graphically,

<center>
```{r, echo = FALSE}
# define function to construct graph for assumptions
almost_sas <- function(aov.results){
  aov_residuals <- residuals(aov.results)
  par(mfrow=c(2,2))
  plot(aov.results, which=1)
  hist(aov_residuals)
  plot(aov.results, which=2)
}

# use the function to create the graph
almost_sas(m)
```
</center>

## ANOVA Assumptions: Test for Variance

- We can formally check the variance assumption with the Brown-Forsythe-Levine test.

    - This test transforms the data and then performs ANOVA!
    
- The test statistic is calculated as follows, $$ F_0 = \frac{\sum_{i=1}^k n_i (\bar{z}_i - \bar{z})^2/(k-1)}{\sum_{i=1}^k \sum_{j=1}^{n_j}(z_{ij}-\bar{z}_i)^2/(n-k) }, $$ where

    - $k$ is the number of groups,
    - $n_i$ is the sample size of group i,
    - $n = \sum_{i=1}^k n_i$, and
    - $z_{ij} = |y_{ij} - \text{median}(y_i)|$

## ANOVA Assumptions: Test for Variance

**Brown-Forsythe-Levine Test for Homoskedasticity**

- **Hypotheses**

    - $H_0: \ \sigma^2_1 = ... = \sigma^2_k$
    - $H_1:$ at least one $\sigma^2_i$ is different

- **Test Statistic**

    - $F_0$ (take from resulting ANOVA table)
    
- ***p*-Value**

    - $p = P[F_0 \ge F_{\text{df}_{\text{Trt}}, \text{df}_{\text{E}}}]$
    
- **Rejection Region**

    - Reject if $p < \alpha$.
  
## ANOVA Assumptions: Test for Variance

- We will use the [`leveneTest()`](https://www.rdocumentation.org/packages/car/versions/3.1-0/topics/leveneTest) function from the [`car`](https://www.rdocumentation.org/packages/car/versions/3.1-0) package.

```{r, echo = TRUE, eval = FALSE}
leveneTest([model results])
```

## ANOVA Assumptions: Test for Variance

- Let's formally test the variance in the dental example,

```{r, message = FALSE, warning = FALSE}
library(car)
leveneTest(m)
```
## ANOVA Assumptions: Test for Variance

- **Hypotheses**

    - $H_0: \ \sigma^2_1 = \sigma^2_2 = \sigma^2_3 = \sigma^2_4$
    - $H_1:$ at least one $\sigma^2_i$ is different

- **Test Statistic and *p*-Value**

    - $F_0 = 0.734$
    - $p = 0.547$
    
- **Rejection Region**

    - Reject if $p < \alpha$; $\alpha=0.05$.
    
- **Conclusion/Interpretation**

    - Fail to reject $H_0$.
    - There is not sufficient evidence to suggest that the variances are different.
    - i.e., the variance assumption is not broken.

## Example

- Recall the [Palmer Penguin](https://allisonhorst.github.io/palmerpenguins/) data in R.

- We determined that there is a difference in bill lengths between the three species,
```{r, echo = TRUE}
penguins <- palmerpenguins::penguins
m1 <- lm(bill_length_mm ~ species, data = penguins)
anova(m1)
```

- Let's now assess the assumptions.

## Example

- First, the graphical assessment.

<center>
```{r}
almost_sas(m1)
```
</center>

## Example

- We can also formally test the variance,

```{r}
leveneTest(m1)
```

## Example

- **Hypotheses**

    - $H_0: \ \sigma^2_1 = \sigma^2_2 = \sigma^2_3$
    - $H_1:$ at least one $\sigma^2_i$ is different

- **Test Statistic and *p*-Value**

    - $F_0 = 2.243$
    - $p = 0.108$
    
- **Rejection Region**

    - Reject if $p < \alpha$; $\alpha=0.05$.
    
- **Conclusion/Interpretation**

    - Fail to reject $H_0$.
    - There is not sufficient evidence to suggest that the variances are different.
    - i.e., the variance assumption is not broken.

