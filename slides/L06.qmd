---
title: "Independent Medians: Wilcoxon Rank Sum (Mann-Whitney *U*)"
subtitle: "STA4173: Biostatistics"
execute:
  echo: true
format: 
  revealjs:
    theme: uwf
    self-contained: true
    slide-number: false
    footer: "[STA4173 - Biostatistics](https://samanthaseals.github.io/STA4173)"
    width: 1600
    height: 900
    df-print: paged
    html-math-method: katex
editor: source
---

## Introduction

- In the last lecture, we discussed assumptions on *t*-tests

    - Dependent / paired *t*-test: normality
    
    - Independent two-sample *t*-test: normality and variance
    
- If we break the variance assumption with the two-sample *t*-test, there is an alternative version of the *t*-test.

- If we break the normailty assumption, we must look to nonparametric methods.

## Introduction

- The *t*-tests we have already learned are considered *parametric* methods.

    - There is a distributional assumption on the test.
    
- *Nonparametric* methods do not have distributional assumptions.

    - We typically transform the data to their ranks and then perform calculations.

- Why don't we always use nonparametric methods?

    - They are often less efficient: a larger sample size is required to achieve the same probability of a Type I error.
    
    - They discard useful information :(
    
## Ranking Data

- In the nonparametric tests we will be learning, the data will be ranked.

- Let us first consider a simple example, $$x: \ 1, 7, 10, 2, 6, 8$$

- Our first step is to reorder the data:$$x: \ 1, 2, 6, 7, 8, 10$$

- Then, we replace with the ranks:$$R: \ 1, 2, 3, 4, 5, 6$$

## Ranking Data

- What if all data values are not unique?

    - We will assign the average ranks.

- For example, $$x: \ 9, 8, 8, 0, 3, 4, 4, 8$$

- Let's reorder:$$x: \ 0, 3, 4, 4, 8, 8, 8, 9$$

- Rank ignoring ties:$$R: \ 1, 2, 3, 4, 5, 6, 7, 8$$

- Now, the final rank:$$R: \ 1, 2, 3.5, 3.5, 6, 6, 6, 8$$

## Wilcoxon Rank Sum / Mann-Whitney *U*

**Wilcoxon Rank Sum / Mann-Whitney *U***

<center><img src="images/L06a.png"></center>

- where *S* is the sum of the ranks from sample 1

## Wilcoxon Rank Sum / Mann-Whitney *U*

-   We will use the [`wilcox.test()`](https://www.rdocumentation.org/packages/stats/versions/3.6.1/topics/wilcox.test) function to perform the test,

```{r, echo = TRUE, eval = FALSE}
wilcox.test([continuous variable] ~ [grouping variable],
            data = [dataset],
            alternative = "[alternative]",
            mu = [hypothesized value],
            exact = FALSE)
```

- Like before, R will use the group that is "first" in the grouping variable.

    - "First" is in terms of numeric or alphabetical.

## Wilcoxon Rank Sum / Mann-Whitney *U*

- When exposed to an infection, a person typically develops antibodies. The extent to which the antibodies respond can be measured by looking at a personâ€™s titer, which is a measure of the number of antibodies present. The higher the titer is, the more antibodies that are present. 

- The following data represent the titers of 11 ill people and 11 healthy people exposed to the tularemia virus in Vermont. 

- Is the level of titer in the ill group greater than the level of titer in the healthy group? Use the $\alpha = 0.1$ level of significance.

```{r}
ill <- c(640, 160, 1280, 320, 80, 640, 640, 160, 1280, 640, 160)
healthy <- c(10, 320, 160, 160, 320, 320, 10, 320, 320, 80, 640)
```

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Is this independent or dependent data?

- From the problem statement: *The following data represent the titers of 11 ill people and 11 healthy people exposed to the tularemia virus in Vermont.*

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Is this independent or dependent data?

- From the problem statement: *The following data represent the titers of 11 ill people and 11 healthy people exposed to the tularemia virus in Vermont.*

    - <font color="#db0b9d">There were 22 people in the study - those that are ill are not in the healthy group.</font>

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Let's first look at the q-q plot,

<center>
```{r, echo = FALSE}
library(tidyverse)
library(ggpubr)

i <- tibble(ill)
h <- tibble(healthy)

# create QQ plots
p1 <- ggplot(data=i, aes(sample=ill)) +
  stat_qq(size=3) + 
  stat_qq_line() + 
  xlab("Theoretical") +
  ylab("Sample") +
  ggtitle("Ill")+
  theme_minimal()

p2 <- ggplot(data=h, aes(sample=healthy)) +
  stat_qq(size=3) + 
  stat_qq_line() + 
  xlab("Theoretical") +
  ylab("Sample") +
  ggtitle("Healthy")+
  theme_minimal()

# put QQ plots together
ggarrange(p1, p2, ncol=2, nrow=1)
```
</center>

## Wilcoxon Rank Sum / Mann-Whitney *U*

- Is the level of titer in the ill group greater than the level of titer in the healthy group?

```{r}
outcome <- c(640, 160, 1280, 320, 80, 640, 640, 160, 1280, 640, 160,
             10, 320, 160, 160, 320, 320, 10, 320, 320, 80, 640)
group <- c(rep("ill",11), rep("healthy",11))
data <- tibble(outcome, group)

wilcox.test(outcome ~ group, 
            data = data,
            exact = FALSE, 
            alternative="less")
```

## Wilcoxon Rank Sum / Mann-Whitney *U*

- **Hypotheses**

    - $H_0: \ M_{\text{ill}} \le M_{\text{healthy}}$ 
    - $H_1: \ M_{\text{ill}} > M_{\text{healthy}}$
    
- **Test Statistic and *p*-Value**

    - $W = 35$
    - $p = 0.047$
    
- **Rejection Region**

    - Reject $H_0$ if $p < \alpha$; $\alpha = 0.10$.
    
- **Conclusion/Interpretation**

    - Reject $H_0$.
    
    - There is sufficient evidence to suggest that the level of titer in the ill group is greater than the level of titer in the healthy group.

## Example

- Recall the [tapeworm in sheep example](https://samanthaseals.github.io/STA4173/slides/L03.html#/example) from the [two-sample *t*-test lecture](https://samanthaseals.github.io/STA4173/slides/L03.html).

    - A random sample of 24 worm-infested lambs of approximately the same age and health was randomly divided into two groups. 
    
    - Twelve of the lambs were injected with medication and the remaining 12 were left untreated. 

```{r}
worms <- c(18, 43, 28, 50, 16, 32, 13, 35, 38, 33,  6,  7,
           40, 54, 26, 63, 21, 37, 39, 23, 48, 58, 28, 39)
trt <- c(rep("Treated", 12), rep("Not", 12))
data <- tibble(worms, trt)
```

## Example

- Let's first look at the q-q plot,

```{r, echo = FALSE}
worms_trt <- data %>% filter(trt == "Treated") # only treated sheep
worms_not <- data %>% filter(trt == "Not") # only treated sheep

# create QQ plots
p1 <- ggplot(data=worms_trt, aes(sample=worms)) +
  stat_qq(size=3) + 
  stat_qq_line() + 
  xlab("Theoretical") +
  ylab("Sample") +
  ggtitle("Treated")+
  theme_minimal()

p2 <- ggplot(data=worms_not, aes(sample=worms)) +
  stat_qq(size=3) + 
  stat_qq_line() + 
  xlab("Theoretical") +
  ylab("Sample") +
  ggtitle("Untreated")+
  theme_minimal()

# put QQ plots together
ggarrange(p1, p2, ncol=2, nrow=1)
```

## Example

- Since we are applying a nonparametric test, we will describe the data using median and IQR.

```{r}
data %>% 
  group_by(trt) %>%
  summarize(median(worms), IQR(worms))
```

- There is a median of 30 worms in the treated lambs (IQR = 20.5) and a median of 39 worms in the untreated lambs (IQR = 22.0).

## Example

- Is there significant evidence that the untreated lambs have a mean tapeworm count that is more than five units greater than the mean count for the treated lambs? Use $\alpha = 0.10$.

```{r}
wilcox.test(worms ~ trt, 
            data = data,
            exact = FALSE, 
            alternative="greater",
            mu = 5)
```

## Example

- **Hypotheses**

    - $H_0: \ M_{\text{untreated}} - M_{\text{treated}} \le 5$ 
    - $H_1: \ M_{\text{untreated}} - M_{\text{treated}} > 5$
    
- **Test Statistic and *p*-Value**

    - $W = 94.5$
    - $p = 0.102$
    
- **Rejection Region**

    - Reject $H_0$ if $p < \alpha$; $\alpha = 0.10$.
    
- **Conclusion/Interpretation**

    - Fail to reject $H_0$.
    
    - There is not sufficient evidence to suggest that untreated lambs have a mean tapeworm count that is more than five units greater than the mean count for the treated lambs.





































